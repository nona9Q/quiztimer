<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>点数えるよ</title>

<style>
  :root {
    --bg: #111;
    --fg: #fff;
    --panel: #1a1a1a;
    --card: #222;
    --border: #333;

    --gold: #d4af37;
    --silver: #c0c0c0;
    --bronze: #cd7f32;

    --danger: #8b1e1e;
    --danger-hover: #b32626;
  }

  body.light {
    --bg: #f5f5f5;
    --fg: #111;
    --panel: #e5e5e5;
    --card: #ffffff;
    --border: #bbb;

    --gold: #c9a227;
    --silver: #9e9e9e;
    --bronze: #b87333;

    --danger: #c62828;
    --danger-hover: #e53935;
  }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: var(--bg);
    color: var(--fg);
    font-family: sans-serif;
  }

  body {
    display: flex;
    flex-direction: column;
  }

  /* 左上説明 */
  #info {
    position: fixed;
    top: 12px;
    left: 16px;
    font-size: 14px;
    line-height: 1.6;
    opacity: 0.85;
  }

  /* 右上操作 */
  #top-controls {
    position: fixed;
    top: 12px;
    right: 16px;
  }

  /* 中央タイマー */
  #center {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #timer {
    font-size: 140px;
    font-weight: bold;
    letter-spacing: 0.08em;
  }

  /* 下部プレイヤー */
  #players-area {
    border-top: 2px solid var(--border);
    padding: 14px;
    background: var(--panel);
  }

  #players {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .player {
    border: 1px solid var(--border);
    padding: 14px;
    border-radius: 10px;
    background: var(--card);
    display: flex;
    align-items: center;
    gap: 10px;
    transition: border-color 0.2s; /* 色が変わるときのアニメーション */
  }

  .player.rank-1 { border-color: var(--gold); }
  .player.rank-2 { border-color: var(--silver); }
  .player.rank-3 { border-color: var(--bronze); }

  .score.rank-1 { color: var(--gold); }
  .score.rank-2 { color: var(--silver); }
  .score.rank-3 { color: var(--bronze); }

  input {
    background: transparent;
    color: var(--fg);
    border: 1px solid var(--border);
    padding: 6px 8px;
    width: 120px;
    font-size: 16px;
  }

  button {
    background: var(--border);
    color: var(--fg);
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 16px;
    border-radius: 6px;
  }

  button:hover {
    opacity: 0.85;
  }

  .score {
    min-width: 48px;
    text-align: center;
    font-weight: bold;
    font-size: 28px;
    transition: color 0.2s;
  }

  /* 削除ボタン */
  .delete {
    background: var(--danger);
    color: #fff;
  }

  .delete:hover {
    background: var(--danger-hover);
  }
</style>
</head>

<body>

<div id="info">
  → : ピロピロピロ<br>
  ← : ブブー<br>
  Space : タイマーリセット
</div>

<div id="top-controls">
  <button id="themeToggle">モード切替</button>
</div>

<div id="center">
  <div id="timer">0.0</div>
</div>

<div id="players-area">
  <button id="addPlayer">＋ プレイヤー追加</button>
  <div id="players"></div>
</div>

<script>
/* ===== 音声 ===== */
// ファイルがない場合のエラー回避のためtry-catchは入れていませんが
// 同じフォルダに O.wav, X.wav を置いてください
const soundO = new Audio("O.wav");
const soundX = new Audio("X.wav");

function playSound(audio) {
  // 音声ファイル読み込みエラー対策（ファイルがない場合など）
  if (audio) {
    audio.pause();
    audio.currentTime = 0;
    audio.play().catch(() => {}); // 再生エラーを無視
  }
}

/* ===== タイマー ===== */
let time = 0.0;
const timerEl = document.getElementById("timer");
let timerInterval = null;

// ページ読み込み時にタイマー開始
timerInterval = setInterval(() => {
  time += 0.1;
  timerEl.textContent = time.toFixed(1);
}, 100);

function resetTimer() {
  time = 0.0;
  timerEl.textContent = "0.0";
}

/* ===== キー操作 ===== */
document.addEventListener("keydown", (e) => {
  if (e.repeat) return;

  if (e.key === "ArrowRight") playSound(soundO);
  if (e.key === "ArrowLeft") playSound(soundX);
  if (e.key === " ") {
    e.preventDefault();
    resetTimer();
  }
});

/* ===== プレイヤー ===== */
const STORAGE_KEY = "players";
let players = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
  { name: "プレイヤー1", score: 0 }
];

const playersEl = document.getElementById("players");

function savePlayers() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
}

function renderPlayers() {
  playersEl.innerHTML = "";

  // 1. 全員のスコアだけを集めて、高い順に並べる（順位判定用）
  const allScores = players.map(p => p.score).sort((a, b) => b - a);

  // 2. プレイヤーの表示順は配列のまま（追加順）固定する
  players.forEach((player, originalIndex) => {
    const div = document.createElement("div");
    div.className = "player";

    // 3. 順位を計算する
    // 自分のスコアが、高い順リストの何番目に登場するか？
    // indexOfを使うことで、同点なら同じ順位（先に登場したインデックス）が返る
    // 例: スコア[10, 10, 5] の場合、10点はどちらも index 0 (1位) になる
    const rankIndex = allScores.indexOf(player.score);
    
    // 1位(0), 2位(1), 3位(2) ならクラスをつける
    if (rankIndex < 3) {
      div.classList.add(`rank-${rankIndex + 1}`);
    }

    // 名前入力
    const nameInput = document.createElement("input");
    nameInput.value = player.name;
    nameInput.oninput = () => {
      players[originalIndex].name = nameInput.value;
      savePlayers();
    };

    // マイナスボタン
    const minus = document.createElement("button");
    minus.textContent = "−";
    minus.onclick = () => {
      players[originalIndex].score--;
      savePlayers();
      renderPlayers();
    };

    // スコア表示
    const scoreDiv = document.createElement("div");
    scoreDiv.className = "score";
    if (rankIndex < 3) {
      scoreDiv.classList.add(`rank-${rankIndex + 1}`);
    }
    scoreDiv.textContent = player.score;

    // プラスボタン
    const plus = document.createElement("button");
    plus.textContent = "+";
    plus.onclick = () => {
      players[originalIndex].score++;
      savePlayers();
      renderPlayers();
    };

    // 削除ボタン
    const del = document.createElement("button");
    del.textContent = "削除";
    del.className = "delete";
    del.onclick = () => {
      if (confirm(`「${player.name}」を削除しますか？`)) {
        players.splice(originalIndex, 1);
        savePlayers();
        renderPlayers();
      }
    };

    div.append(nameInput, minus, scoreDiv, plus, del);
    playersEl.appendChild(div);
  });
}

// プレイヤー追加ボタン
document.getElementById("addPlayer").onclick = () => {
  players.push({ name: `プレイヤー${players.length + 1}`, score: 0 });
  savePlayers();
  renderPlayers();
};

/* ===== テーマ ===== */
const themeBtn = document.getElementById("themeToggle");
const savedTheme = localStorage.getItem("theme");
if (savedTheme === "light") document.body.classList.add("light");

themeBtn.onclick = () => {
  document.body.classList.toggle("light");
  localStorage.setItem(
    "theme",
    document.body.classList.contains("light") ? "light" : "dark"
  );
};

// 初回描画
renderPlayers();
</script>

</body>
</html>